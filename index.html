<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Online Checkers</title>
  <style>
    body { background:#1e1e1e; color:#ddd; font-family:sans-serif; }
    #board { display:grid; grid-template-columns:repeat(8,60px); grid-template-rows:repeat(8,60px); margin:20px auto; }
    .cell { width:60px; height:60px; display:flex; align-items:center; justify-content:center; font-size:32px; }
    .dark { background:#444; }
    .light { background:#ccc; }
    .piece { cursor:pointer; }
    #ui { text-align:center; margin:20px; }
    #chat { max-height:150px; overflow-y:auto; background:#222; padding:5px; }
    #moves { max-height:150px; overflow-y:auto; background:#222; padding:5px; margin-top:10px; }
    input,button { margin:5px; padding:5px; }
  </style>
</head>
<body>
  <h1 style="text-align:center">Online Checkers</h1>
  <div id="ui">
    <button id="createBtn">Create Room</button>
    <input id="roomInput" placeholder="Room ID">
    <button id="joinBtn">Join Room</button>
    <div id="roomDisplay"></div>
    <div id="rankStats"></div>
  </div>
  <div id="board"></div>
  <div id="chat"></div>
  <input id="chatInput" placeholder="Type message...">
  <button id="sendBtn">Send</button>
  <div id="moves"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD9sgzBhmVoRAgfWK7vPPe1SPpA_7EICXA",
  authDomain: "checkers-282e8.firebaseapp.com",
  projectId: "checkers-282e8",
  storageBucket: "checkers-282e8.firebasestorage.app",
  messagingSenderId: "278516610865",
  appId: "1:278516610865:web:28c0256a814938e39c2210",
  measurementId: "G-FSJHLG5E0X"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- Game State ----------
let boardState = null;
let myColor = null;
let roomId = null;
let selected = null;
let turn = "red";

const boardEl = document.getElementById("board");
const chatEl = document.getElementById("chat");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const movesEl = document.getElementById("moves");
const roomDisplay = document.getElementById("roomDisplay");
const rankStatsEl = document.getElementById("rankStats");

let stats = JSON.parse(localStorage.getItem("checkersStats")||`{"points":0,"wins":0,"losses":0,"draws":0}`);

function renderStats(){ 
  rankStatsEl.textContent = `Points: ${stats.points} | Wins: ${stats.wins} | Losses: ${stats.losses} | Draws: ${stats.draws}`;
}
function saveStats(){ 
  localStorage.setItem("checkersStats", JSON.stringify(stats)); 
  renderStats(); 
}
renderStats();

// ---------- Helpers ----------
function makeInitialBoard(){
  const b = Array.from({length:8}, ()=>Array(8).fill(null));
  for (let r=0;r<3;r++) for (let c=0;c<8;c++) if((r+c)%2==1) b[r][c]="red";
  for (let r=5;r<8;r++) for (let c=0;c<8;c++) if((r+c)%2==1) b[r][c]="black";
  return b;
}

// ---------- Render ----------
function renderBoard(){
  if (!boardState || !Array.isArray(boardState) || !boardState[0]) {
    console.warn("Board not ready yet.");
    return;
  }
  boardEl.innerHTML="";
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const cell=document.createElement("div");
      cell.className="cell "+(((r+c)%2)?"dark":"light");
      if(boardState[r][c]){
        const piece=document.createElement("div");
        piece.textContent=boardState[r][c]==="red"?"ðŸ”´":"âš«";
        piece.className="piece";
        if(myColor===boardState[r][c] && turn===myColor) {
          piece.onclick=()=>selected={r,c};
        }
        cell.appendChild(piece);
      } else {
        if(selected && turn===myColor && (r+c)%2===1){
          cell.onclick=()=>attemptMove(selected.r,selected.c,r,c);
        }
      }
      boardEl.appendChild(cell);
    }
  }
}

// ---------- Moves ----------
function attemptMove(sr,sc,tr,tc){
  const piece=boardState[sr][sc];
  if(!piece) return;
  const dr=tr-sr, dc=tc-sc;
  if(Math.abs(dr)===1 && Math.abs(dc)===1 && !boardState[tr][tc]){
    boardState[tr][tc]=piece; boardState[sr][sc]=null;
    turn=(turn==="red"?"black":"red");
    push(ref(db,`rooms/${roomId}/moves`),{from:[sr,sc],to:[tr,tc],piece});
    update(ref(db,`rooms/${roomId}`),{board:boardState,turn});
    selected=null;
    renderBoard();
  } else if(Math.abs(dr)===2 && Math.abs(dc)===2 && !boardState[tr][tc]){
    const mr=sr+dr/2, mc=sc+dc/2;
    if(boardState[mr][mc] && boardState[mr][mc]!==piece){
      boardState[tr][tc]=piece; boardState[sr][sc]=null; boardState[mr][mc]=null;
      turn=(turn==="red"?"black":"red");
      push(ref(db,`rooms/${roomId}/moves`),{from:[sr,sc],to:[tr,tc],piece,captured:[mr,mc]});
      update(ref(db,`rooms/${roomId}`),{board:boardState,turn});
      selected=null;
      renderBoard();
    }
  }
}

// ---------- Chat ----------
sendBtn.onclick=()=>{
  if(!roomId) return;
  const msg=chatInput.value.trim();
  if(!msg) return;
  push(ref(db,`rooms/${roomId}/chat`),{msg,time:Date.now()});
  chatInput.value="";
};
function listenForChat(){
  onValue(ref(db,`rooms/${roomId}/chat`),(snap)=>{
    chatEl.innerHTML="";
    snap.forEach(s=>{
      const d=document.createElement("div");
      d.textContent=s.val().msg;
      chatEl.appendChild(d);
    });
    chatEl.scrollTop=chatEl.scrollHeight;
  });
}
function listenForMoves(){
  onValue(ref(db,`rooms/${roomId}/moves`),(snap)=>{
    movesEl.innerHTML="";
    snap.forEach(s=>{
      const m=s.val();
      const d=document.createElement("div");
      d.textContent=`${m.piece} from ${m.from} to ${m.to}`;
      movesEl.appendChild(d);
    });
    movesEl.scrollTop=movesEl.scrollHeight;
  });
}

// ---------- Rooms ----------
document.getElementById("createBtn").onclick=createRoom;
document.getElementById("joinBtn").onclick=()=>joinRoom(document.getElementById("roomInput").value);

function createRoom(){
  roomId=Math.random().toString(36).slice(2,8);
  myColor="red";
  boardState=makeInitialBoard();
  set(ref(db,`rooms/${roomId}`),{
    board:boardState,
    turn:"red",
    players:{}
  });
  roomDisplay.textContent=`Room: ${roomId} (You are Red)`;
  renderBoard();
  listenForChat();
  listenForMoves();
  onValue(ref(db,`rooms/${roomId}/board`),(snap)=>{
    const val=snap.val();
    if(val){ boardState=val; renderBoard(); }
  });
  onValue(ref(db,`rooms/${roomId}/turn`),(snap)=>{
    const val=snap.val();
    if(val) turn=val;
  });
}

function joinRoom(id){
  roomId=id;
  myColor="black";
  roomDisplay.textContent=`Room: ${roomId} (You are Black)`;
  listenForChat();
  listenForMoves();
  onValue(ref(db,`rooms/${roomId}/board`),(snap)=>{
    const val=snap.val();
    if(val){ boardState=val; renderBoard(); }
  });
  onValue(ref(db,`rooms/${roomId}/turn`),(snap)=>{
    const val=snap.val();
    if(val) turn=val;
  });
}

boardState=makeInitialBoard();
renderBoard();
</script>
</body>
</html>
